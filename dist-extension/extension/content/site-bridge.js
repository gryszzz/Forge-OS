(function(){"use strict";function d(t){if(Array.isArray(t))return t;if(typeof t!="string")return null;const e=t.trim();if(!e)return[];try{const n=JSON.parse(e);return Array.isArray(n)?n:null}catch{return null}}function f(t){return!t||typeof t!="object"?null:t}function O(t){const e=d(t);if(!e)return null;const n=e.slice(-64),r=[];for(const _ of n){const l=f(_);l&&r.push(l)}const o=JSON.stringify(r);return o.length>3e5?null:{json:o,count:r.length}}function S(){return{json:"[]",count:0}}const i="forgeos.session.agents.v2",c="forgeos.managed.wallet.v1",s="__forgeos__";function g(t){if(!t)return null;try{const e=JSON.parse(t);if(typeof e!="object"||e===null)return null;const n={};return typeof e.address=="string"&&(n.address=e.address),typeof e.network=="string"&&(n.network=e.network),n.address?JSON.stringify(n):null}catch{return null}}function a(t){return O(t)??S()}function u(){try{const t=a(localStorage.getItem(i)),e=g(localStorage.getItem(c));chrome.runtime.sendMessage({type:"FORGEOS_SYNC",agents:t.json,wallet:e}).catch(()=>{})}catch{}}u(),window.addEventListener("storage",t=>{(t.key===i||t.key===c)&&u()}),setInterval(u,1e4),window.addEventListener("message",t=>{if(t.source!==window)return;const e=t.data;if(e!=null&&e[s]){if(e.type==="FORGEOS_BRIDGE_PING"){const n=typeof e.requestId=="string"?e.requestId:"";window.postMessage({[s]:!0,type:"FORGEOS_BRIDGE_PONG",requestId:n,result:{bridgeReady:!0,transport:"content-script"}},"*");return}if(e.type==="FORGEOS_AGENT_SNAPSHOT"){const n=a(e.agents);chrome.runtime.sendMessage({type:"FORGEOS_SYNC_AGENTS",agents:n.json,source:"push",updatedAt:Date.now()}).catch(()=>{});return}if(e.type==="FORGEOS_OPEN_POPUP"){chrome.runtime.sendMessage({type:"FORGEOS_OPEN_POPUP"}).catch(()=>{});return}if(e.type==="FORGEOS_CONNECT"){const n=typeof e.requestId=="string"?e.requestId:"";if(!n){window.postMessage({[s]:!0,requestId:n,result:null,error:"Invalid connect request"},"*");return}chrome.runtime.sendMessage({type:"FORGEOS_OPEN_POPUP"}).catch(()=>{}),chrome.runtime.sendMessage({type:"FORGEOS_OPEN_FOR_CONNECT",requestId:n}).catch(r=>{window.postMessage({[s]:!0,requestId:n,result:null,error:(r==null?void 0:r.message)??"Connection failed"},"*")});return}if(e.type==="FORGEOS_SIGN"){const n=typeof e.requestId=="string"?e.requestId:"",r=typeof e.message=="string"?e.message:null;if(!n||r===null){window.postMessage({[s]:!0,requestId:n,result:null,error:"Invalid sign request"},"*");return}chrome.runtime.sendMessage({type:"FORGEOS_OPEN_FOR_SIGN",requestId:n,message:r}).catch(o=>{window.postMessage({[s]:!0,requestId:n,result:null,error:(o==null?void 0:o.message)??"Signing failed"},"*")});return}}}),chrome.runtime.onMessage.addListener(t=>{((t==null?void 0:t.type)==="FORGEOS_CONNECT_RESULT"||(t==null?void 0:t.type)==="FORGEOS_SIGN_RESULT")&&window.postMessage({[s]:!0,requestId:t.requestId,result:t.result??null,error:t.error??void 0},"*")})})();
