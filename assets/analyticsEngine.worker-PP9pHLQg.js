(function(){"use strict";function Q(o,n){var I,B,W,z,F,K,O,V,q,G,N,j;const h={totalDecisions:0,accumulateCount:0,reduceCount:0,holdCount:0,rebalanceCount:0,winRate:0,avgConfidence:0,avgKelly:0,sharpeRatio:0,sortinoRatio:0,maxDrawdown:0,profitFactor:0,calmarRatio:0,avgWinPct:0,avgLossPct:0,streakWins:0,streakLosses:0,realizedPnl:0,unrealizedPnl:0,var95:0,cvar95:0};if(!o||o.length===0)return h;const f=o.filter(t=>{var e;return((e=t.dec)==null?void 0:e.action)==="ACCUMULATE"}),D=o.filter(t=>{var e;return((e=t.dec)==null?void 0:e.action)==="REDUCE"}),x=o.filter(t=>{var e;return((e=t.dec)==null?void 0:e.action)==="HOLD"}),R=o.filter(t=>{var e;return((e=t.dec)==null?void 0:e.action)==="REBALANCE"}),w=[];for(const t of o){const e=(B=(I=t==null?void 0:t.dec)==null?void 0:I.audit_record)==null?void 0:B.decision_hash;if(e){const a=(n||[]).find(i=>{var v,J;return((J=(v=i==null?void 0:i.dec)==null?void 0:v.audit_record)==null?void 0:J.decision_hash)===e&&(i.status==="confirmed"||i.receipt_lifecycle==="confirmed")});a&&w.push({decision:t,tx:a})}}let M=0,l=0,d=0,g=0;for(let t=0;t<w.length-1;t++){const e=w[t],a=w[t+1];if(((W=e.decision.dec)==null?void 0:W.action)==="ACCUMULATE"){const i=((z=e.decision.kasData)==null?void 0:z.priceUsd)||0,v=((K=(F=a==null?void 0:a.decision)==null?void 0:F.kasData)==null?void 0:K.priceUsd)||i;v>i?(M++,d+=(v-i)/i):v<i&&(l++,g+=(i-v)/i)}}const L=M+l,A=L>0?M/L*100:50,r=[];for(let t=1;t<o.length;t++){const e=((V=(O=o[t-1])==null?void 0:O.kasData)==null?void 0:V.priceUsd)||0,a=((G=(q=o[t])==null?void 0:q.kasData)==null?void 0:G.priceUsd)||0;e>0&&r.push((a-e)/e)}const E=o.reduce((t,e)=>{var a;return t+(((a=e.dec)==null?void 0:a.confidence_score)||0)},0)/o.length,b=o.reduce((t,e)=>{var a;return t+(((a=e.dec)==null?void 0:a.kelly_fraction)||0)},0)/o.length;let p=0,u=0;for(const t of o){const e=((N=t==null?void 0:t.kasData)==null?void 0:N.priceUsd)||0;if(e>0){e>u&&(u=e);const a=(u-e)/u;a>p&&(p=a)}}const C=r.length>0?r.reduce((t,e)=>t+e,0)/r.length:0,U=r.length>1?Math.sqrt(r.reduce((t,e)=>t+Math.pow(e-C,2),0)/(r.length-1)):0,s=U>0?C/U*Math.sqrt(252):0,c=r.filter(t=>t<0),y=c.length>0?Math.sqrt(c.reduce((t,e)=>t+e*e,0)/c.length):0,Y=y>0?C/y*Math.sqrt(252):0,Z=p>0?C*252/p:0,$=g>0?d/g:d>0?999:0,tt=M>0?d/M*100:0,et=l>0?g/l*100:0,_=[...r].sort((t,e)=>t-e),P=Math.floor(r.length*.05),nt=r.length>P?Math.abs(_[P]||0):.05;let H=0;if(r.length>P){const t=_.slice(0,P+1);H=Math.abs(t.reduce((e,a)=>e+a,0)/t.length)}let S=0,T=0,m=0,k=null;for(const t of o){const e=(j=t.dec)==null?void 0:j.action;e==="ACCUMULATE"?(m=k==="win"||k===null?m+1:1,m>S&&(S=m),k="win"):(e==="REDUCE"||e==="HOLD")&&(m=k==="loss"||k===null?m+1:1,m>T&&(T=m),k="loss")}return{totalDecisions:o.length,accumulateCount:f.length,reduceCount:D.length,holdCount:x.length,rebalanceCount:R.length,winRate:A,avgConfidence:E,avgKelly:b,sharpeRatio:s,sortinoRatio:Y,maxDrawdown:p*100,profitFactor:$,calmarRatio:Z,avgWinPct:tt,avgLossPct:et,streakWins:S,streakLosses:T,realizedPnl:0,unrealizedPnl:0,var95:nt*100,cvar95:H*100}}function X(o){if(!o||o.length<20)return null;const n=o.map(s=>{var c;return(c=s==null?void 0:s.kasData)==null?void 0:c.priceUsd}).filter(s=>s!=null&&s>0);if(n.length<20)return null;const h=14;let f=0,D=0;for(let s=n.length-h;s<n.length-1;s++){const c=n[s+1]-n[s];c>0?f+=c:D+=Math.abs(c)}const x=f/h,R=D/h,M=100-100/(1+(R>0?x/R:100)),l=n.slice(-20).reduce((s,c)=>s+c,0)/Math.min(20,n.length),d=n.length>=50?n.slice(-50).reduce((s,c)=>s+c,0)/50:l,g=n[n.length-1],L=Math.round((g-l)/l*1e4)/100,A=Math.round((g-d)/d*1e4)/100,r=g>l&&l>d?"bullish":g<l&&l<d?"bearish":"neutral",E=n[n.length-1]>n[Math.max(0,n.length-5)]?"BULLISH":"BEARISH",b=n[n.length-1]>n[Math.max(0,n.length-20)]?"BULLISH":"BEARISH",p=Math.round((n[n.length-1]-n[Math.max(0,n.length-24)])/n[Math.max(0,n.length-24)]*100*100)/100,u=[];for(let s=1;s<n.length;s++)u.push((n[s]-n[s-1])/n[s-1]);const C=u.length>0?u.reduce((s,c)=>s+c,0)/u.length:0,U=Math.round(Math.sqrt(u.reduce((s,c)=>s+Math.pow(c-C,2),0)/Math.max(1,u.length))*Math.sqrt(252)*1e4)/100;return{rsi:Math.round(M*10)/10,sma20:Math.round(l*1e5)/1e5,sma50:Math.round(d*1e5)/1e5,priceVsSma20:L,priceVsSma50:A,trend:r,shortTermTrend:E,mediumTermTrend:b,volatility:U,currentPrice:Math.round(g*1e5)/1e5,priceChange24h:p}}self.onmessage=o=>{const n=o.data;if(!(!n||typeof n.id!="number"))try{const h=Q(n.decisions||[],n.queue||[]),f=X(n.decisions||[]),D={id:n.id,ok:!0,metrics:h,indicators:f};self.postMessage(D)}catch(h){const f={id:n.id,ok:!1,error:String((h==null?void 0:h.message)||"analytics worker error")};self.postMessage(f)}}})();
