(function(){"use strict";function i(e,t=0){const r=Number(e);return Number.isFinite(r)?r:t}function m(e,t,r){return Math.min(r,Math.max(t,e))}function te(e){return e.length?e.reduce((t,r)=>t+r,0)/e.length:0}function Ee(e){if(e.length<2)return 0;const t=te(e);return e.reduce((r,n)=>r+(n-t)**2,0)/(e.length-1)}function re(e){return Math.sqrt(Math.max(0,Ee(e)))}function V(e){return e[e.length-1]}function be(e){if(e.length<2)return[];const t=[];for(let r=1;r<e.length;r+=1)t.push(e[r]-e[r-1]);return t}function Y(e,t=1){if(e.length<=t)return 0;const r=V(e),n=e[e.length-1-t];return!(n>0)||!Number.isFinite(r)?0:(r-n)/n}function Ie(e){const t=[];for(let r=1;r<e.length;r+=1){const n=e[r-1],s=e[r];n>0&&s>0&&t.push(Math.log(s/n))}return t}function Te(e,t=.94){if(!e.length)return 0;let r=e[0]**2;for(let n=1;n<e.length;n+=1)r=t*r+(1-t)*e[n]**2;return Math.sqrt(Math.max(0,r))}function xe(e){if(e.length<2)return 0;const t=e.length;let r=0,n=0,s=0,a=0;for(let _=0;_<t;_+=1)r+=_,n+=e[_],s+=_*e[_],a+=_*_;const c=t*a-r*r;return c===0?0:(t*s-r*n)/c}function ke(e,t){if(!t.length)return 0;const r=re(t);return r===0?0:(e-te(t))/r}function Oe(e){if(!e.length)return 0;let t=e[0],r=0;for(const n of e)n>t&&(t=n),t>0&&(r=Math.max(r,(t-n)/t));return r}function Le(e){return e>30?1:e<-30?0:1/(1+Math.exp(-e))}function l(e,t=4){const r=10**t;return Math.round(e*r)/r}function j(e,t){return t<=0?[]:e.slice(Math.max(0,e.length-t))}function Ce(e){const t=String((e==null?void 0:e.risk)||"medium").toLowerCase(),r=String((e==null?void 0:e.strategyTemplate)||"").toLowerCase();if(t==="low"){const s={label:"low",kellyCap:.08,riskCeiling:.42,exposureCapPct:.12,drawdownPenaltyStart:.03};return r==="dca_accumulator"?{...s,kellyCap:.06,exposureCapPct:.1,drawdownPenaltyStart:.025}:r==="mean_reversion"?{...s,riskCeiling:.38,exposureCapPct:.1}:s}if(t==="high"){const s={label:"high",kellyCap:.22,riskCeiling:.82,exposureCapPct:.35,drawdownPenaltyStart:.1};return r==="vol_breakout"?{...s,kellyCap:.2,exposureCapPct:.28,riskCeiling:.76}:s}const n={label:"medium",kellyCap:.14,riskCeiling:.65,exposureCapPct:.22,drawdownPenaltyStart:.06};return r==="trend"?{...n,kellyCap:.16,exposureCapPct:.24}:r==="dca_accumulator"?{...n,kellyCap:.1,riskCeiling:.58,exposureCapPct:.16,drawdownPenaltyStart:.045}:r==="mean_reversion"?{...n,riskCeiling:.56,exposureCapPct:.18}:r==="vol_breakout"?{...n,kellyCap:.12,riskCeiling:.6,drawdownPenaltyStart:.05}:n}function ne(e){var a,c,_,o,d,u,p,S;if(!e)return null;const t=i(e.ts??e.fetched??((a=e==null?void 0:e.kasData)==null?void 0:a.fetched)??((c=e==null?void 0:e.kasData)==null?void 0:c.ts),NaN),r=i(e.priceUsd??e.price??((_=e==null?void 0:e.kasData)==null?void 0:_.priceUsd),0),n=i(e.daaScore??((o=e==null?void 0:e.dag)==null?void 0:o.daaScore)??((d=e==null?void 0:e.kasData)==null?void 0:d.daaScore)??((p=(u=e==null?void 0:e.kasData)==null?void 0:u.dag)==null?void 0:p.daaScore),0),s=i(e.walletKas??((S=e==null?void 0:e.kasData)==null?void 0:S.walletKas),0);return!Number.isFinite(t)||t<=0?null:{ts:t,priceUsd:Math.max(0,r),daaScore:Math.max(0,n),walletKas:Math.max(0,s)}}function Ne(e,t){const r=[];for(const a of Array.isArray(t==null?void 0:t.history)?t.history:[]){const c=ne(a);c&&r.push(c)}const n=ne(e);n&&r.push(n),r.sort((a,c)=>a.ts-c.ts);const s=[];for(const a of r){const c=s[s.length-1];c&&a.ts===c.ts&&a.priceUsd===c.priceUsd&&a.daaScore===c.daaScore&&a.walletKas===c.walletKas||s.push(a)}return s.slice(-240)}function Pe(e){return e<.008?"LOW":e<.02?"MEDIUM":"HIGH"}function we(e,t){return!(t>0)||e<=t*.06?"MINIMAL":e<=t*.2?"MODERATE":"SIGNIFICANT"}function Re(e,t,r,n){return e<-.45||r>.12&&t>.02?"RISK_OFF":e>.4&&t<.03&&n>=0?"TREND_UP":Math.abs(e)<.15&&t>.015?"RANGE_VOL":n>.25&&e>=0?"FLOW_ACCUMULATION":"NEUTRAL"}function Ue(e){const t=[];return e.dataQualityScore<.55&&t.push("Limited local sample history"),e.volatilityEstimate==="HIGH"&&t.push("Elevated short-horizon volatility"),e.drawdownPct>.08&&t.push("Recent drawdown pressure"),e.liquidityImpact!=="MINIMAL"&&t.push("Position size may impact wallet liquidity"),e.regime==="RISK_OFF"&&t.push("Risk-off regime detected"),t.length===0&&t.push("Normal market conditions"),t.slice(0,5)}function $e(e){const t=e.momentumScore>.2?"positive momentum":e.momentumScore<-.2?"negative momentum":"mixed momentum",r=e.regime.toLowerCase().replace(/_/g," ");return[`${e.action} because the local quant core detects ${r} with ${t}, EWMA volatility ${(e.ewmaVol*100).toFixed(2)}%, and DAA velocity ${l(e.daaVelocity,2)}.`,`Model win probability is ${(e.winProbability*100).toFixed(1)}% with expected value ${l(e.expectedValuePct,2)}%; sizing is capped by risk profile and data-quality score ${l(e.dataQualityScore,2)}.`].join(" ")}function He(e,t,r){const n=Ne(t,r),s=Ce(e),a=Math.max(0,i(e==null?void 0:e.capitalLimit,0)),c=n[n.length-1],_=i(r==null?void 0:r.now,Date.now()),o=n.map(O=>O.priceUsd).filter(O=>O>0),d=n.map(O=>O.daaScore).filter(O=>O>0),u=n.map(O=>O.walletKas).filter(O=>O>=0),p=Ie(o),S=j(p,24),y=p.length?V(p):0,M=Te(S,.92),A=Pe(M),E=Y(o,1),b=Y(o,5),I=Y(o,20),R=E*1.4+b*.9+I*.6,v=m(R*12,-2,2),f=m(ke(y,S),-4,4),g=be(d),x=g.length?V(g):0,L=xe(j(d,16)),U=re(j(g,16)),Q=m(L/Math.max(1,Math.abs(x)||1)*.25+(x>0?.15:-.1),-1,1),$=Oe(j(o,48)),de=m(o.length/32,0,1),lt=m(d.length/32,0,1),_t=m(n.length/48,0,1),P=m(.15+_t*.45+de*.3+lt*.1,.15,1),pe=m(M/.03,0,2),me=m(($-s.drawdownPenaltyStart)/Math.max(.01,.2-s.drawdownPenaltyStart),0,1.2),ut=1-P,dt=m(v/2,-1,1),pt=Le(.1+dt*1.25+Q*.55-pe*.55-me*.6),w=m(.5+(pt-.5)*(.4+P*.6),.35,.82),mt=l(w*100,2),he=v>.35?2.1:v<-.35?1.1:A==="HIGH"?1.3:1.7,K=l(m(M*100*2.2+1.4,1.2,12),2),fe=l(m(K*he,2.2,22),2),H=l(w*fe-(1-w)*K,2),ht=Math.max(.01,he),ye=Math.max(0,w-(1-w)/ht),ge=m(s.kellyCap*(.55+.45*P),.02,s.kellyCap),D=l(m(ye,0,ge),4),q=l(m(.18+pe*.26+me*.28+(v<-.35?.16:0)+(A==="HIGH"&&U>15?.1:0)+ut*.18-(v>.35?.06:0),.04,.98),4),B=Re(v,M,$,Q),ft=l(H/Math.max(1,K),4),Se=Math.max(0,i((c==null?void 0:c.walletKas)??(t==null?void 0:t.walletKas),0)),G=Se>0?Se:Math.max(0,V(u)||0);let k="HOLD";q>s.riskCeiling+.08&&v<-.2&&G>.5?k="REDUCE":H>.35&&D>.01&&q<=s.riskCeiling?k="ACCUMULATE":Math.abs(v)<.12&&A==="HIGH"&&(k="REBALANCE");const ee=a*D*(1+m(H/6,0,.65)),yt=a*s.exposureCapPct,Me=G>0?G*Math.max(.08,s.exposureCapPct):a;let N=Math.min(a,Math.max(0,ee),yt,Me);k==="HOLD"&&(N=0),k==="REDUCE"&&(N=Math.min(Math.max(a*.05,ee),G*.25||a)),k==="REBALANCE"&&(N=Math.min(Math.max(a*.03,ee*.7),Me)),N=l(Math.max(0,N),6);const gt=a>0?l(m(N/a*100,0,100),2):0,Ae=we(N,G||a||1),St=k==="ACCUMULATE"?B==="TREND_UP"?"ENTRY":"SCALING":k==="REDUCE"?"EXIT":"HOLDING",Mt=l(m(.52+m(Math.abs(H)/5,0,.2)+P*.15-q*.12+(k==="HOLD"?.02:0),.45,.97),4),At=Ue({dataQualityScore:P,volatilityEstimate:A,drawdownPct:$,liquidityImpact:Ae,regime:B}),vt=$e({action:k,regime:B,momentumScore:v,ewmaVol:M,winProbability:w,expectedValuePct:H,dataQualityScore:P,daaVelocity:x}),ve=m(Math.round(45+q*120+(A==="HIGH"?45:0)),45,240),Et=new Date(_+ve*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),bt={regime:B,sample_count:n.length,data_quality_score:l(P,4),price_usd:l(i(V(o),i(t==null?void 0:t.priceUsd,0)),6),price_return_1_pct:l(E*100,4),price_return_5_pct:l(b*100,4),price_return_20_pct:l(I*100,4),momentum_z:l(f,4),ewma_volatility:l(M,6),daa_velocity:l(x,4),daa_slope:l(L,4),drawdown_pct:l($*100,4),win_probability_model:l(w,4),edge_score:l(ft,4),kelly_raw:l(ye,4),kelly_cap:l(ge,4),risk_ceiling:l(s.riskCeiling,4),risk_profile:s.label,exposure_cap_pct:l(s.exposureCapPct*100,4),strategy_template:String((e==null?void 0:e.strategyTemplate)||"custom")};return{action:k,confidence_score:Mt,risk_score:q,kelly_fraction:D,capital_allocation_kas:N,capital_allocation_pct:gt,expected_value_pct:H,stop_loss_pct:K,take_profit_pct:fe,monte_carlo_win_pct:mt,volatility_estimate:A,liquidity_impact:Ae,strategy_phase:St,rationale:vt,risk_factors:At,next_review_trigger:`Re-evaluate in ~${ve}s (around ${Et}) or on >${l(K/2,2)}% price move / regime change.`,decision_source:"quant-core",decision_source_detail:`regime:${B};samples:${n.length}`,quant_metrics:bt}}function Ve(e){return{...e||{},risk_factors:Array.isArray(e==null?void 0:e.risk_factors)?[...e.risk_factors]:[],quant_metrics:e!=null&&e.quant_metrics&&typeof e.quant_metrics=="object"?{...e.quant_metrics}:void 0}}function Fe(e){const t=new Map;return{get(r){return t.get(r)||null},set(r,n,s){for(t.set(r,{ts:Date.now(),signature:n,decision:Ve(s)});t.size>e;){const a=t.keys().next().value;if(!a)break;t.delete(a)}}}}function Ke(e,t){var S,y;const r=String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"default").trim().toLowerCase(),n=String((e==null?void 0:e.risk)||"medium").trim().toLowerCase(),s=String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom").trim().toLowerCase(),a=String((e==null?void 0:e.execMode)||(e==null?void 0:e.mode)||"default").trim().toLowerCase(),c=l(Math.max(0,i(e==null?void 0:e.capitalLimit,0)),6),_=l(Math.max(0,i(e==null?void 0:e.kpiTarget,0)),4),o=Math.max(0,Math.round(i(e==null?void 0:e.horizon,0))),d=l(Math.max(0,i(e==null?void 0:e.autoApproveThreshold,0)),6),u=String((t==null?void 0:t.address)||"").trim().toLowerCase(),p=String(((S=t==null?void 0:t.dag)==null?void 0:S.networkName)||((y=t==null?void 0:t.dag)==null?void 0:y.network)||"").trim().toLowerCase();return[r,n,`tpl:${s}`,`mode:${a}`,`${c}`,`kpi:${_}`,`hz:${o}`,`aa:${d}`,`addr:${u}`,`net:${p}`].join("|")}function qe(e){const t=(e==null?void 0:e.quant_metrics)||{},r=String(t.regime||"NA"),n=String((e==null?void 0:e.volatility_estimate)||"NA"),s=String((e==null?void 0:e.action)||"HOLD"),a=Math.round(m(i(e==null?void 0:e.confidence_score,0)*10,0,10)),c=Math.round(m(i(e==null?void 0:e.risk_score,1)*10,0,10)),_=Math.round(m(i(t.edge_score,0)*10,-20,20)),o=Math.round(m(i(e==null?void 0:e.kelly_fraction,0)*100,0,100)),d=Math.round(m(i(t.data_quality_score,0)*10,0,10)),u=Math.round(m(i(t.sample_count,0),0,999));return[r,n,s,`c${a}`,`r${c}`,`e${_}`,`k${o}`,`d${d}`,`s${u}`].join("|")}const z="sha256/canonical-json";function J(e){if(e==null)return"null";const t=typeof e;return t==="number"?Number.isFinite(e)?JSON.stringify(e):"null":t==="boolean"?e?"true":"false":t==="string"?JSON.stringify(e):Array.isArray(e)?`[${e.map(r=>J(r)).join(",")}]`:t==="object"?`{${Object.entries(e).filter(([n,s])=>typeof s<"u").sort(([n],[s])=>n.localeCompare(s)).map(([n,s])=>`${JSON.stringify(n)}:${J(s)}`).join(",")}}`:"null"}async function Be(e){var a;const r=new TextEncoder().encode(e),n=(a=globalThis.crypto)==null?void 0:a.subtle;if(!n||typeof n.digest!="function")throw new Error("SHA-256 hashing requires WebCrypto subtle.digest");const s=await n.digest("SHA-256",r);return Array.from(new Uint8Array(s)).map(c=>c.toString(16).padStart(2,"0")).join("")}async function W(e){return`${z}:${await Be(J(e))}`}function Ge(e,t){return{audit_record_version:String((e==null?void 0:e.audit_record_version)||t.decisionAuditRecordVersion),hash_algo:String((e==null?void 0:e.hash_algo)||t.auditHashAlgo),prompt_version:String((e==null?void 0:e.prompt_version)||t.aiPromptVersion),ai_response_schema_version:String((e==null?void 0:e.ai_response_schema_version)||t.aiResponseSchemaVersion),quant_feature_snapshot_hash:String((e==null?void 0:e.quant_feature_snapshot_hash)||""),decision_hash:String((e==null?void 0:e.decision_hash)||""),overlay_plan_reason:String((e==null?void 0:e.overlay_plan_reason)||""),engine_path:String((e==null?void 0:e.engine_path)||""),created_ts:Math.max(0,Math.round(i(e==null?void 0:e.created_ts,Date.now())))}}function ie(e){return new Promise(t=>setTimeout(t,e))}function oe(e){const t=Math.floor(Math.random()*90);return 160*(e+1)+t}function je(e){try{return JSON.parse(e)}catch{throw new Error("AI response was not valid JSON")}}function ze(e){const t={"Content-Type":"application/json"};if(e.apiUrl.includes("api.anthropic.com")){if(!e.anthropicApiKey)throw new Error("Anthropic API key missing. Set VITE_ANTHROPIC_API_KEY or configure VITE_AI_API_URL to your secure backend endpoint.");t["x-api-key"]=e.anthropicApiKey,t["anthropic-version"]="2023-06-01"}return t}function Qe(e,t,r){var a,c,_,o,d,u,p;const n={fetched:i(t==null?void 0:t.fetched,0),address:String((t==null?void 0:t.address)||""),walletKas:l(i(t==null?void 0:t.walletKas,0),6),priceUsd:l(i(t==null?void 0:t.priceUsd,0),8),dag:{daaScore:i((a=t==null?void 0:t.dag)==null?void 0:a.daaScore,0),difficulty:i(((c=t==null?void 0:t.dag)==null?void 0:c.difficulty)??((_=t==null?void 0:t.dag)==null?void 0:_.virtualDaaScore),0),networkName:String(((o=t==null?void 0:t.dag)==null?void 0:o.networkName)||((d=t==null?void 0:t.dag)==null?void 0:d.network)||""),pastMedianTime:i(((u=t==null?void 0:t.dag)==null?void 0:u.pastMedianTime)??((p=t==null?void 0:t.dag)==null?void 0:p.virtualPastMedianTime),0)}},s=(r==null?void 0:r.quant_metrics)||{};return`You are a quant-grade AI risk overlay for a Kaspa-native autonomous trading engine. The local quant core (deterministic math) has already computed features, regime, Kelly cap, and risk limits. Your job is to refine the decision WITHOUT violating the local risk envelope.

Respond ONLY with a valid JSON object â€” no markdown, no prose, no code fences.

AGENT PROFILE:
Name: ${e.name}
Strategy: momentum / on-chain flow / risk-controlled execution
Risk Tolerance: ${e.risk} (low=conservative, high=aggressive)
KPI Target: ${e.kpiTarget}% ROI
Capital per Cycle: ${e.capitalLimit} KAS
Auto-Approve Threshold: ${e.autoApproveThreshold} KAS

KASPA SNAPSHOT:
${JSON.stringify(n)}

LOCAL QUANT CORE PRIOR (trust this as the primary signal unless you have a strong reason):
${JSON.stringify({action:r.action,confidence_score:r.confidence_score,risk_score:r.risk_score,kelly_fraction:r.kelly_fraction,capital_allocation_kas:r.capital_allocation_kas,expected_value_pct:r.expected_value_pct,stop_loss_pct:r.stop_loss_pct,take_profit_pct:r.take_profit_pct,monte_carlo_win_pct:r.monte_carlo_win_pct,quant_metrics:s,rationale:r.rationale,risk_factors:r.risk_factors})}

RULES:
1. Do not exceed quant_metrics.kelly_cap in kelly_fraction.
2. Do not exceed local quant capital_allocation_kas by more than 25%.
3. If quant_metrics.regime is RISK_OFF, avoid ACCUMULATE unless confidence_score >= 0.9 and risk_score <= quant_metrics.risk_ceiling.
4. Preserve strict risk discipline; prefer HOLD over low-quality conviction.
5. Keep rationale concise and reference actual metrics from the snapshot/core prior.

OUTPUT (strict JSON, all fields required):
{
  "action": "ACCUMULATE or REDUCE or HOLD or REBALANCE",
  "confidence_score": 0.00,
  "risk_score": 0.00,
  "kelly_fraction": 0.00,
  "capital_allocation_kas": 0.00,
  "capital_allocation_pct": 0,
  "expected_value_pct": 0.00,
  "stop_loss_pct": 0.00,
  "take_profit_pct": 0.00,
  "monte_carlo_win_pct": 0,
  "volatility_estimate": "LOW or MEDIUM or HIGH",
  "liquidity_impact": "MINIMAL or MODERATE or SIGNIFICANT",
  "strategy_phase": "ENTRY or SCALING or HOLDING or EXIT",
  "rationale": "Two concise sentences citing specific metrics and why this refines the quant-core prior.",
  "risk_factors": ["factor1", "factor2", "factor3"],
  "next_review_trigger": "Describe the specific condition that should trigger next decision cycle"
}`}async function Ye(e){var d;const{agent:t,kasData:r,quantCoreDecision:n,config:s,sanitizeDecision:a}=e,c=Qe(t,r,n),_=s.apiUrl.includes("api.anthropic.com")?{model:s.model,max_tokens:900,messages:[{role:"user",content:c}]}:{prompt:c,agent:t,kasData:r,quantCore:n};let o;for(let u=0;u<s.maxAttempts;u+=1){const p=new AbortController,S=setTimeout(()=>p.abort(),s.timeoutMs);try{const y=await fetch(s.apiUrl,{method:"POST",headers:ze(s),body:JSON.stringify(_),signal:p.signal});if(!y.ok){const M=Number(y.status||0);if(s.retryableStatuses.has(M)&&u+1<s.maxAttempts){await ie(oe(u));continue}throw new Error(`AI endpoint ${M||"request_failed"}`)}o=await y.json();break}catch(y){const M=(y==null?void 0:y.name)==="AbortError",A=String((y==null?void 0:y.message)||""),E=(y==null?void 0:y.name)==="TypeError"||/failed to fetch|network|load failed/i.test(A);if(!M&&E&&u+1<s.maxAttempts){await ie(oe(u));continue}throw y}finally{clearTimeout(S)}}if((d=o==null?void 0:o.error)!=null&&d.message)throw new Error(o.error.message);if(Array.isArray(o==null?void 0:o.content)){const u=o.content.map(S=>S.text||"").join(""),p=je(u.replace(/```json|```/g,"").trim());return a({...p,decision_source:"ai"},t)}return o!=null&&o.decision?a({...o.decision,decision_source:"ai"},t):a({...o,decision_source:"ai"},t)}function Je(e){const{coreDecision:t,cached:r,config:n}=e,s=Date.now(),a=qe(t),c=(t==null?void 0:t.quant_metrics)||{};if(!n.aiTransportReady)return{kind:"skip",reason:"ai_transport_not_configured",signature:a};if(n.aiOverlayMode==="off")return{kind:"skip",reason:"ai_overlay_mode_off",signature:a};if(n.aiOverlayMode==="always")return{kind:"call",reason:"ai_overlay_mode_always",signature:a};if(r&&r.signature===a){const v=Math.max(0,s-r.ts);if(v<=n.minIntervalMs)return{kind:"reuse",reason:`cache_hit_min_interval_${v}ms`,signature:a};if(n.aiOverlayMode==="adaptive"&&v<=n.cacheTtlMs){const f=i(t==null?void 0:t.confidence_score,0),g=i(t==null?void 0:t.risk_score,1),x=i(c.risk_ceiling,.65),L=String(c.regime||"NEUTRAL"),U=Math.abs(i(c.edge_score,0)),Q=f<.88&&f>.56,$=Math.abs(g-x)<.06;if(!Q&&!$&&!(L==="RISK_OFF"||L==="RANGE_VOL")&&U>.2)return{kind:"reuse",reason:`cache_hit_stable_state_${v}ms`,signature:a}}}const _=i(c.data_quality_score,0),o=i(t==null?void 0:t.confidence_score,0),d=i(t==null?void 0:t.risk_score,1),u=i(c.risk_ceiling,.65),p=String(c.regime||"NEUTRAL"),S=Math.abs(i(c.edge_score,0)),y=i(c.sample_count,0),M=i(t==null?void 0:t.kelly_fraction,0);if(_<.4||y<6)return{kind:"skip",reason:"low_data_quality",signature:a};const A=p==="RISK_OFF"||p==="RANGE_VOL",E=Math.abs(d-u)<.08,b=o<.9&&o>.58,I=S<.12;return _>=.72&&o>=.88&&!A&&!E&&S>=.25&&(M===0||M>=.02)?{kind:"skip",reason:"quant_core_high_conviction",signature:a}:A||E||b||I?{kind:"call",reason:"adaptive_uncertain_or_sensitive",signature:a}:{kind:"skip",reason:"adaptive_cost_control",signature:a}}function We(e,t,r){const n=[...Array.isArray(e)?e:[],...Array.isArray(t)?t:[]];return r&&n.push(r),Array.from(new Set(n.map(s=>String(s).trim()).filter(Boolean))).slice(0,6)}function Xe(e){var x,L,U;const{agent:t,coreDecision:r,aiDecision:n,aiLatencyMs:s,startedAt:a,sanitizeDecision:c}=e,_=String(((x=r==null?void 0:r.quant_metrics)==null?void 0:x.regime)||"NEUTRAL"),o=i((L=r==null?void 0:r.quant_metrics)==null?void 0:L.risk_ceiling,.65),d=String((n==null?void 0:n.action)||"HOLD");let u=d,p=!1;_==="RISK_OFF"&&d==="ACCUMULATE"&&(u=r.action==="REDUCE"?"REDUCE":"HOLD",p=!0),i(r==null?void 0:r.risk_score,0)>o&&d==="ACCUMULATE"&&(u=r.action==="REDUCE"?"REDUCE":"HOLD",p=!0);const S=l(Math.max(i(r==null?void 0:r.risk_score,1),i(n==null?void 0:n.risk_score,1)),4);let y=l(m(i(r==null?void 0:r.confidence_score,.5)*.58+i(n==null?void 0:n.confidence_score,.5)*.42-(p?.08:0),0,1),4);u==="HOLD"&&(y=Math.min(y,.86));const M=i((U=r==null?void 0:r.quant_metrics)==null?void 0:U.kelly_cap,i(r==null?void 0:r.kelly_fraction,0)),A=l(m(Math.min(Math.max(i(r==null?void 0:r.kelly_fraction,0)*.8,i(n==null?void 0:n.kelly_fraction,0)*.6),M||1),0,1),4);let E=0;const b=i(r==null?void 0:r.capital_allocation_kas,0),I=i(n==null?void 0:n.capital_allocation_kas,0);u==="ACCUMULATE"?E=Math.min(I||b,b*1.25||I||0):(u==="REDUCE"||u==="REBALANCE")&&(E=Math.min(Math.max(b,I*.75),Math.max(b*1.5,I)));const R=We(r==null?void 0:r.risk_factors,n==null?void 0:n.risk_factors,p?"AI signal conflict; core risk override applied":void 0),v=String((n==null?void 0:n.rationale)||"AI overlay unavailable.").trim(),g=`${String((r==null?void 0:r.rationale)||"").trim()} AI overlay: ${v}`.slice(0,900);return c({...n,action:u,confidence_score:y,risk_score:S,kelly_fraction:A,capital_allocation_kas:u==="HOLD"?0:E,expected_value_pct:l(i(r==null?void 0:r.expected_value_pct,0)*.6+i(n==null?void 0:n.expected_value_pct,0)*.4,2),stop_loss_pct:l(Math.max(i(r==null?void 0:r.stop_loss_pct,0),i(n==null?void 0:n.stop_loss_pct,0)),2),take_profit_pct:l(i(r==null?void 0:r.take_profit_pct,0)*.6+i(n==null?void 0:n.take_profit_pct,0)*.4,2),monte_carlo_win_pct:l(i(r==null?void 0:r.monte_carlo_win_pct,0)*.65+i(n==null?void 0:n.monte_carlo_win_pct,0)*.35,2),volatility_estimate:(r==null?void 0:r.volatility_estimate)||(n==null?void 0:n.volatility_estimate),liquidity_impact:(r==null?void 0:r.liquidity_impact)||(n==null?void 0:n.liquidity_impact),strategy_phase:u==="ACCUMULATE"?(r==null?void 0:r.strategy_phase)||(n==null?void 0:n.strategy_phase):(n==null?void 0:n.strategy_phase)||(r==null?void 0:r.strategy_phase),rationale:g,risk_factors:R,next_review_trigger:(r==null?void 0:r.next_review_trigger)||(n==null?void 0:n.next_review_trigger),decision_source:"hybrid-ai",decision_source_detail:`regime:${_};ai_latency_ms:${s};mode:quant_core_guarded`,quant_metrics:{...(r==null?void 0:r.quant_metrics)||{},ai_overlay_applied:!0,ai_action_raw:d,ai_confidence_raw:i(n==null?void 0:n.confidence_score,0)},engine_latency_ms:Date.now()-a},t)}const T={};function Ze(e,t=!1){const r=String(e??"").trim();return r?/^(1|true|yes)$/i.test(r):t}function De(e){const t=String(e||"always").trim().toLowerCase();return t==="off"||t==="always"||t==="adaptive"?t:"adaptive"}const X=T.VITE_AI_API_URL||"https://api.anthropic.com/v1/messages",se=T.VITE_ANTHROPIC_API_KEY||"",ae=Math.max(0,Number(T.VITE_AI_OVERLAY_MIN_INTERVAL_MS||15e3)),et=Math.max(ae,Number(T.VITE_AI_OVERLAY_CACHE_TTL_MS||45e3)),h={aiApiUrl:X,aiModel:T.VITE_AI_MODEL||"claude-sonnet-4-20250514",anthropicApiKey:se,aiTimeoutMs:Math.max(800,Number(T.VITE_AI_SOFT_TIMEOUT_MS||2200)),aiFallbackEnabled:String(T.VITE_AI_FALLBACK_ENABLED||"true").toLowerCase()!=="false",aiOverlayMode:De(T.VITE_AI_OVERLAY_MODE),aiOverlayMinIntervalMs:ae,aiOverlayCacheTtlMs:et,aiOverlayCacheMaxEntries:512,aiTransportReady:!!X&&(!X.includes("api.anthropic.com")||!!se),aiMaxAttempts:Math.max(1,Math.min(3,Number(T.VITE_AI_MAX_ATTEMPTS||2))),aiRetryableStatuses:new Set([408,425,429,500,502,503,504]),decisionAuditRecordVersion:"forgeos.decision.audit.v1",aiPromptVersion:"forgeos.quant.overlay.prompt.v1",aiResponseSchemaVersion:"forgeos.ai.decision.schema.v1",auditSignerUrl:String(T.VITE_DECISION_AUDIT_SIGNER_URL||"").trim(),auditSignerToken:String(T.VITE_DECISION_AUDIT_SIGNER_TOKEN||"").trim(),auditSignerTimeoutMs:Math.max(500,Number(T.VITE_DECISION_AUDIT_SIGNER_TIMEOUT_MS||1500)),auditSignerRequired:Ze(T.VITE_DECISION_AUDIT_SIGNER_REQUIRED,!1)};function Z(e,t){return[String(e||"").trim(),t].filter(Boolean).join(";").slice(0,220)}function ce(e){const{agent:t,coreDecision:r,reason:n,startedAt:s,sanitizeDecision:a}=e;return a({...r,decision_source:"quant-core",decision_source_detail:Z(r==null?void 0:r.decision_source_detail,`fallback_reason:${n}`),engine_latency_ms:Date.now()-s},t)}function le(e){var c;const{agent:t,cached:r,startedAt:n,reason:s,sanitizeDecision:a}=e;return a({...r.decision||{},decision_source:"hybrid-ai",decision_source_detail:Z((c=r==null?void 0:r.decision)==null?void 0:c.decision_source_detail,s),engine_latency_ms:Date.now()-n},t)}const _e=Fe(h.aiOverlayCacheMaxEntries);function tt(){const e={"Content-Type":"application/json"};return h.auditSignerToken&&(e.Authorization=`Bearer ${h.auditSignerToken}`),e}async function rt(e){var a;const t=e==null?void 0:e.audit_record;if(!t||!h.auditSignerUrl)return e;const r=Ge(t,{decisionAuditRecordVersion:h.decisionAuditRecordVersion,auditHashAlgo:z,aiPromptVersion:h.aiPromptVersion,aiResponseSchemaVersion:h.aiResponseSchemaVersion}),n=new AbortController,s=setTimeout(()=>n.abort(),h.auditSignerTimeoutMs);try{const c=await fetch(h.auditSignerUrl,{method:"POST",headers:tt(),body:JSON.stringify({signingPayload:r}),signal:n.signal}),_=await c.json().catch(()=>({}));if(!c.ok)throw new Error(String(((a=_==null?void 0:_.error)==null?void 0:a.message)||`audit_signer_${c.status||"failed"}`));const o=_!=null&&_.signature&&typeof _.signature=="object"?_.signature:_,d={status:"signed",alg:String((o==null?void 0:o.alg)||(o==null?void 0:o.algorithm)||"unknown").slice(0,80),key_id:String((o==null?void 0:o.keyId)||(o==null?void 0:o.key_id)||"").slice(0,160),sig_b64u:String((o==null?void 0:o.signatureB64u)||(o==null?void 0:o.signature)||(o==null?void 0:o.sig_b64u)||"").slice(0,600),payload_hash_sha256_b64u:String((o==null?void 0:o.payloadHashSha256B64u)||(o==null?void 0:o.payload_hash_sha256_b64u)||"").slice(0,160),signer:String((o==null?void 0:o.signer)||"audit-signer").slice(0,80),signed_ts:Math.max(0,Math.round(i((o==null?void 0:o.signedAt)??(o==null?void 0:o.signed_ts),Date.now()))),signing_latency_ms:Math.max(0,Math.round(i((o==null?void 0:o.signingLatencyMs)??(o==null?void 0:o.signing_latency_ms),0))),public_key_pem:typeof(o==null?void 0:o.publicKeyPem)=="string"?o.publicKeyPem.slice(0,4e3):typeof(o==null?void 0:o.public_key_pem)=="string"?o.public_key_pem.slice(0,4e3):void 0};return{...e,audit_record:{...t,crypto_signature:d}}}catch(c){const _=(c==null?void 0:c.name)==="AbortError"?`audit_signer_timeout_${h.auditSignerTimeoutMs}ms`:String((c==null?void 0:c.message)||"audit_signer_failed");if(h.auditSignerRequired)throw new Error(_);return{...e,audit_record:{...t,crypto_signature:{status:"error",signer:"audit-signer",error:_.slice(0,240)}}}}finally{clearTimeout(s)}}function nt(e){if(!e||typeof e!="object"||Array.isArray(e))return;const t={};for(const[r,n]of Object.entries(e))if(r){if(typeof n=="number"){if(!Number.isFinite(n))continue;t[r]=Math.abs(n)>=1e3?Math.round(n):l(n,6);continue}if(typeof n=="string"){t[r]=n.slice(0,80);continue}typeof n=="boolean"&&(t[r]=n)}return Object.keys(t).length>0?t:void 0}function C(e,t){const r=String((e==null?void 0:e.action)||"HOLD").toUpperCase(),n=["ACCUMULATE","REDUCE","HOLD","REBALANCE"].includes(r)?r:"HOLD",s=Math.max(0,i(t==null?void 0:t.capitalLimit,0)),a=m(i(e==null?void 0:e.capital_allocation_kas,0),0,s),c=s>0?m(a/s*100,0,100):m(i(e==null?void 0:e.capital_allocation_pct,0),0,100),_=m(i(e==null?void 0:e.confidence_score,0),0,1),o=m(i(e==null?void 0:e.risk_score,1),0,1),d=String((e==null?void 0:e.volatility_estimate)||"MEDIUM").toUpperCase(),u=["LOW","MEDIUM","HIGH"].includes(d)?d:"MEDIUM",p=String((e==null?void 0:e.liquidity_impact)||"MODERATE").toUpperCase(),S=["MINIMAL","MODERATE","SIGNIFICANT"].includes(p)?p:"MODERATE",y=String((e==null?void 0:e.strategy_phase)||"HOLDING").toUpperCase(),M=["ENTRY","SCALING","HOLDING","EXIT"].includes(y)?y:"HOLDING",A=Array.isArray(e==null?void 0:e.risk_factors)?e.risk_factors.map(L=>String(L)).filter(Boolean).slice(0,6):[],E=String((e==null?void 0:e.decision_source)||"ai").toLowerCase(),b=["ai","fallback","quant-core","hybrid-ai"].includes(E)?E:"ai",I=String((e==null?void 0:e.decision_source_detail)||"").slice(0,220),R=nt(e==null?void 0:e.quant_metrics),v=Math.max(0,Math.round(i(e==null?void 0:e.engine_latency_ms,0))),f=e!=null&&e.audit_record&&typeof e.audit_record=="object"?e.audit_record:null,g=f!=null&&f.crypto_signature&&typeof f.crypto_signature=="object"?f.crypto_signature:null,x=f?{audit_record_version:String(f.audit_record_version||h.decisionAuditRecordVersion).slice(0,80),hash_algo:String(f.hash_algo||z).slice(0,64),prompt_version:String(f.prompt_version||h.aiPromptVersion).slice(0,80),ai_response_schema_version:String(f.ai_response_schema_version||h.aiResponseSchemaVersion).slice(0,80),quant_feature_snapshot_hash:String(f.quant_feature_snapshot_hash||"").slice(0,120),decision_hash:String(f.decision_hash||"").slice(0,120),audit_sig:String(f.audit_sig||"").slice(0,140),overlay_plan_reason:String(f.overlay_plan_reason||"").slice(0,160),engine_path:String(f.engine_path||"").slice(0,80),prompt_used:!!f.prompt_used,ai_transport_ready:!!f.ai_transport_ready,created_ts:Math.max(0,Math.round(i(f.created_ts,0))),crypto_signature:g?{status:String(g.status||"").slice(0,32)||void 0,alg:String(g.alg||"").slice(0,80)||void 0,key_id:String(g.key_id||g.keyId||"").slice(0,160)||void 0,sig_b64u:String(g.sig_b64u||g.signatureB64u||"").slice(0,600)||void 0,payload_hash_sha256_b64u:String(g.payload_hash_sha256_b64u||g.payloadHashSha256B64u||"").slice(0,160)||void 0,signer:String(g.signer||"").slice(0,80)||void 0,signed_ts:Math.max(0,Math.round(i(g.signed_ts??g.signedAt,0))),signing_latency_ms:Math.max(0,Math.round(i(g.signing_latency_ms??g.signingLatencyMs,0))),public_key_pem:typeof g.public_key_pem=="string"?g.public_key_pem.slice(0,4e3):typeof g.publicKeyPem=="string"?g.publicKeyPem.slice(0,4e3):void 0,error:String(g.error||"").slice(0,240)||void 0}:void 0,quant_feature_snapshot_excerpt:f.quant_feature_snapshot_excerpt&&typeof f.quant_feature_snapshot_excerpt=="object"?{regime:String(f.quant_feature_snapshot_excerpt.regime||"").slice(0,40),sample_count:Math.max(0,Math.round(i(f.quant_feature_snapshot_excerpt.sample_count,0))),edge_score:l(i(f.quant_feature_snapshot_excerpt.edge_score,0),6),data_quality_score:l(i(f.quant_feature_snapshot_excerpt.data_quality_score,0),6),price_usd:l(i(f.quant_feature_snapshot_excerpt.price_usd,0),8),wallet_kas:l(i(f.quant_feature_snapshot_excerpt.wallet_kas,0),6),daa_score:Math.max(0,Math.round(i(f.quant_feature_snapshot_excerpt.daa_score,0)))}:void 0}:void 0;return{action:n,confidence_score:l(_,4),risk_score:l(o,4),kelly_fraction:m(i(e==null?void 0:e.kelly_fraction,0),0,1),capital_allocation_kas:Number(a.toFixed(6)),capital_allocation_pct:Number(c.toFixed(2)),expected_value_pct:Number(i(e==null?void 0:e.expected_value_pct,0).toFixed(2)),stop_loss_pct:Number(Math.max(0,i(e==null?void 0:e.stop_loss_pct,0)).toFixed(2)),take_profit_pct:Number(Math.max(0,i(e==null?void 0:e.take_profit_pct,0)).toFixed(2)),monte_carlo_win_pct:Number(m(i(e==null?void 0:e.monte_carlo_win_pct,0),0,100).toFixed(2)),volatility_estimate:u,liquidity_impact:S,strategy_phase:M,rationale:String((e==null?void 0:e.rationale)||"No rationale returned by engine."),risk_factors:A,next_review_trigger:String((e==null?void 0:e.next_review_trigger)||"On next cycle or major DAA/price movement."),decision_source:b,decision_source_detail:I,quant_metrics:R,engine_latency_ms:v,...x?{audit_record:x}:{}}}function it(e,t,r){var s,a,c;const n=(r==null?void 0:r.quant_metrics)||{};return{agent:{id:String((e==null?void 0:e.agentId)||(e==null?void 0:e.name)||"agent"),risk:String((e==null?void 0:e.risk)||""),capitalLimit:l(Math.max(0,i(e==null?void 0:e.capitalLimit,0)),6),autoApproveThreshold:l(Math.max(0,i(e==null?void 0:e.autoApproveThreshold,0)),6),strategyTemplate:String((e==null?void 0:e.strategyTemplate)||(e==null?void 0:e.strategyLabel)||"custom")},kaspa:{address:String((t==null?void 0:t.address)||""),walletKas:l(Math.max(0,i(t==null?void 0:t.walletKas,0)),6),priceUsd:l(Math.max(0,i(t==null?void 0:t.priceUsd,0)),8),daaScore:Math.max(0,Math.round(i((s=t==null?void 0:t.dag)==null?void 0:s.daaScore,0))),network:String(((a=t==null?void 0:t.dag)==null?void 0:a.networkName)||((c=t==null?void 0:t.dag)==null?void 0:c.network)||"")},quantCore:{action:String((r==null?void 0:r.action)||"HOLD"),confidence_score:l(i(r==null?void 0:r.confidence_score,0),4),risk_score:l(i(r==null?void 0:r.risk_score,0),4),kelly_fraction:l(i(r==null?void 0:r.kelly_fraction,0),6),capital_allocation_kas:l(i(r==null?void 0:r.capital_allocation_kas,0),6),expected_value_pct:l(i(r==null?void 0:r.expected_value_pct,0),4),quant_metrics:{regime:String((n==null?void 0:n.regime)||""),sample_count:Math.max(0,Math.round(i(n==null?void 0:n.sample_count,0))),edge_score:l(i(n==null?void 0:n.edge_score,0),6),data_quality_score:l(i(n==null?void 0:n.data_quality_score,0),6),ewma_volatility:l(i(n==null?void 0:n.ewma_volatility,0),6),risk_ceiling:l(i(n==null?void 0:n.risk_ceiling,0),6),kelly_cap:l(i(n==null?void 0:n.kelly_cap,0),6)}}}}async function ot(e){var _,o,d,u,p,S,y,M,A,E,b,I;const t=e.decision||{},r=it(e.agent,e.kasData,e.quantCoreDecision),n=await W(r),s={...t,audit_record:void 0},a=await W(s),c=await W({decision_hash:a,quant_feature_snapshot_hash:n,prompt_version:h.aiPromptVersion,ai_response_schema_version:h.aiResponseSchemaVersion,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath});return C({...t,audit_record:{audit_record_version:h.decisionAuditRecordVersion,hash_algo:z,prompt_version:h.aiPromptVersion,ai_response_schema_version:h.aiResponseSchemaVersion,quant_feature_snapshot_hash:n,decision_hash:a,audit_sig:c,overlay_plan_reason:e.overlayPlanReason,engine_path:e.enginePath,prompt_used:e.enginePath==="hybrid-ai"||e.enginePath==="ai",ai_transport_ready:h.aiTransportReady,created_ts:Date.now(),quant_feature_snapshot_excerpt:{regime:String(((o=(_=e.quantCoreDecision)==null?void 0:_.quant_metrics)==null?void 0:o.regime)||""),sample_count:Math.max(0,Math.round(i((u=(d=e.quantCoreDecision)==null?void 0:d.quant_metrics)==null?void 0:u.sample_count,0))),edge_score:l(i((S=(p=e.quantCoreDecision)==null?void 0:p.quant_metrics)==null?void 0:S.edge_score,0),6),data_quality_score:l(i((M=(y=e.quantCoreDecision)==null?void 0:y.quant_metrics)==null?void 0:M.data_quality_score,0),6),price_usd:l(i((A=e.kasData)==null?void 0:A.priceUsd,0),8),wallet_kas:l(i((E=e.kasData)==null?void 0:E.walletKas,0),6),daa_score:Math.max(0,Math.round(i((I=(b=e.kasData)==null?void 0:b.dag)==null?void 0:I.daaScore,0)))}}},e.agent)}async function F(e){const t=await ot(e);return rt(t)}function st(e){return _e.get(e)}function at(e,t,r){_e.set(e,t,r)}async function ct(e,t,r){const n=Date.now(),s=C({...He(e,t,r),engine_latency_ms:Date.now()-n},e),a=Ke(e,t),c=st(a),_=Je({coreDecision:s,cached:c,config:{aiTransportReady:h.aiTransportReady,aiOverlayMode:h.aiOverlayMode,minIntervalMs:h.aiOverlayMinIntervalMs,cacheTtlMs:h.aiOverlayCacheTtlMs}});if(_.kind==="skip"&&_.reason==="ai_transport_not_configured"&&!h.aiFallbackEnabled&&h.aiOverlayMode!=="off")throw new Error("Real AI overlay is required but AI transport is not configured (set VITE_AI_API_URL and credentials/proxy).");if(_.kind==="skip")return F({decision:ce({agent:e,coreDecision:s,reason:_.reason,startedAt:n,sanitizeDecision:C}),agent:e,kasData:t,quantCoreDecision:s,overlayPlanReason:_.reason,enginePath:"quant-core"});if(_.kind==="reuse"&&c)return F({decision:le({agent:e,cached:c,startedAt:n,reason:_.reason,sanitizeDecision:C}),agent:e,kasData:t,quantCoreDecision:s,overlayPlanReason:_.reason,enginePath:"hybrid-ai"});const o=Date.now();try{const d=await Ye({agent:e,kasData:t,quantCoreDecision:s,config:{apiUrl:h.aiApiUrl,model:h.aiModel,anthropicApiKey:h.anthropicApiKey,timeoutMs:h.aiTimeoutMs,maxAttempts:h.aiMaxAttempts,retryableStatuses:h.aiRetryableStatuses},sanitizeDecision:C}),u=Date.now()-o,p=Xe({agent:e,coreDecision:s,aiDecision:d,aiLatencyMs:u,startedAt:n,sanitizeDecision:C});return p.decision_source_detail=Z(p==null?void 0:p.decision_source_detail,`overlay_plan:${_.reason}`),at(a,_.signature,p),F({decision:p,agent:e,kasData:t,quantCoreDecision:s,overlayPlanReason:_.reason,enginePath:"hybrid-ai"})}catch(d){if(c){const u=Math.max(0,Date.now()-c.ts);if(u<=h.aiOverlayCacheTtlMs)return F({decision:le({agent:e,cached:c,startedAt:n,reason:`ai_error_cache_reuse_${u}ms`,sanitizeDecision:C}),agent:e,kasData:t,quantCoreDecision:s,overlayPlanReason:`ai_error_cache_reuse_${u}ms`,enginePath:"hybrid-ai"})}if(h.aiFallbackEnabled){const u=(d==null?void 0:d.name)==="AbortError"?`ai_timeout_${h.aiTimeoutMs}ms`:(d==null?void 0:d.message)||"request failure";return F({decision:ce({agent:e,coreDecision:s,reason:u,startedAt:n,sanitizeDecision:C}),agent:e,kasData:t,quantCoreDecision:s,overlayPlanReason:u,enginePath:"quant-core"})}throw(d==null?void 0:d.name)==="AbortError"?new Error(`AI request timeout (${h.aiTimeoutMs}ms)`):d}}const ue=1e4;self.onmessage=async e=>{const t=e.data;if(!(!t||typeof t.id!="number"))try{const r=new Promise((a,c)=>setTimeout(()=>c(new Error(`Quant engine timed out after ${ue}ms`)),ue)),n=await Promise.race([ct(t.agent,t.kasData,t.context),r]),s={id:t.id,ok:!0,decision:n};self.postMessage(s)}catch(r){const n={id:t.id,ok:!1,error:String((r==null?void 0:r.message)||"Quant worker request failed")};self.postMessage(n)}}})();
